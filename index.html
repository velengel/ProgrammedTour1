<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µã¦ã™ã¨</title>
</head>

<body>
  <h1>å‘½ä»¤å½¢äººç”Ÿä½“é¨“ãƒ„ã‚¢ãƒ¼</h1><br>
  <div style="margin-left:10%;margin-right:10%;">
    <button onClick="deviceMotionRequest()" style="width:100%;padding:10px;font-size:20px;">åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µè¨±å¯ğŸ˜Š</button>
  </div>

  <h2><div id="instruction"></div></h2>

  <font size=7>
    
    <br>
    <div id="txt">ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</div>

  </font>


  <script>
    var aX = 0, aY = 0, aZ = 0;
    var index=0, As=[];
    As.length=100;
    var A = 0;
    var phase = 0;

    function deviceMotionRequest() {
      if (DeviceMotionEvent.requestPermission) {
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              window.addEventListener("devicemotion", function (event) {
                if (!event.accelerationIncludingGravity) {
                  alert('event.accelerationIncludingGravity is null');
                  return;
                }
                aX = event.accelerationIncludingGravity.x.toFixed(2);
                aY = event.accelerationIncludingGravity.y.toFixed(2);
                aZ = event.accelerationIncludingGravity.z.toFixed(2);
                A = Math.sqrt(aX*aX+aY*aY+aZ*aZ).toFixed(2)
              })
            }
          })
          .catch(console.error);
      } else {
        alert('DeviceMotionEvent.requestPermission is not found')
      }
    }

    var timer = window.setInterval(() => {
      displayData();      // displayData é–¢æ•°ã‚’å®Ÿè¡Œ
      displayInstruction();
    }, 100); // 33msã”ã¨ã«ï¼ˆ1ç§’é–“ã«ç´„30å›ï¼‰

    function displayData() {
      var txt = document.getElementById("txt");   
      /* txt.innerHTML = "x: " + aX + "<br>"         
        + "y: " + aY + "<br>"         
        + "z: " + aZ + "<br>"
        + "A: " + A; //*/

      
      
      //ç›´å‰ã®å€¤ã‚’ä¿å­˜
      index++;
      As[index%100]=A;
      index%=100;

      //ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸåˆ¤å®š
      var dif = A-As[(index-1)%100];
      if(index > 30 && dif<-2 && phase == 0 && Math.abs(As[(index-1)%100])>1){
        alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n  ã‚‚ã—åº§ã£ã¦ã„ãŸã‚‰ã€ç«‹ã¡ä¸ŠãŒã‚‹ã€‚");
        phase = 1;
        index=0;
        As=[];
      }

      if(index > 30 && dif<-2 && phase == 1){
        alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n  ã‚‚ã—å£ã«å½“ãŸã‚Šãã†ã«ãªã£ãŸã‚‰ã€ç«‹ã¡æ­¢ã¾ã‚‹ã€‚");
        phase = 2;
        index=0;
        As=[];
      }
    }

    function displayInstruction() {
      var inst = document.getElementById("instruction");
      switch(phase){
        case 0:
          inst.innerHTML = "å‘½ä»¤ï¼šç«‹ã¡ä¸ŠãŒã£ã¦ãã ã•ã„ã€‚";
          txt.innerHTML = '<img src="./img/standup.png" width = 50% />'
          break;
        case 1:
          inst.innerHTML = "å‘½ä»¤ï¼šå£ã«å‘ã‹ã£ã¦æ­©ã„ã¦ãã ã•ã„ã€‚"
          txt.innerHTML = '<img src="./img/walk.png" width = 50% />'
          break;
        case 2:
          inst.innerHTML="å‘½ä»¤ï¼šæ¤…å­ã«åº§ã£ã¦ãã ã•ã„ã€‚"
          txt.innerHTML = '<img src="./img/sitdown.png" width = 50% />'
          break;
      }
             
    }
  </script>
</body>

</html>