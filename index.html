<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ‰‹ç¶šãå‹äººç”Ÿä½“é¨“ãƒ„ã‚¢ãƒ¼1</title>
</head>

<body>

  <div style="text-align: center;padding: 5px; margin-bottom: 5px; border: 5px double #333333; border-radius: 10px;">
  
    <h1>
      æ‰‹ç¶šãå‹äººç”Ÿ<br>ä½“é¨“ãƒ„ã‚¢ãƒ¼1
    </h1>
  </div>
  
  
  <div style="padding: 10px 10px 10px 10px;width: auto;">
    <label for="progress">Phase:</label> <progress id="progress" min=-1 max=4 value=-1></progress>
  </div>
    

  
    
  <div style="margin-left:10%;margin-right:10%;">
    
    <button onClick="deviceMotionRequest()" style="width:100%;padding:10px;font-size:20px;">åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µè¨±å¯ğŸ˜Š</button>
  </div>

  <div style="padding: 30px 10px 10px 10px;">
    <label for="acc">Acc Level:</label> <meter id="acc" min=5 max=20 low=5 high=13 optinum=8 value=0></meter>
  </div>

  <h2>
    <div id="instruction"></div>
  </h2>

  <font size=3>

    <br>
    <div id="txt">ã“ã‚Œã‹ã‚‰ã‚ãªãŸã«ã„ãã¤ã‹ã®å‘½ä»¤ã‚’ã™ã‚‹ã®ã§ã€<br>ã‚¹ãƒãƒ›ã‚’æŒã£ãŸã¾ã¾ãã®é€šã‚Šã«å‹•ã„ã¦ã¿ã¦ãã ã•ã„ã€‚<br>ãã®å¾Œã€ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>

  </font>

  <div id="accText"></div>


  <script>
    var aX = 0, aY = 0, aZ = 0;
    var index = 0, As = [];
    As.length = 100;
    var A = 0;
    var phase = -1;


    function deviceMotionRequest() {
      if (DeviceMotionEvent.requestPermission) {
        DeviceMotionEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === 'granted') {
              window.addEventListener("devicemotion", function (event) {
                if (!event.accelerationIncludingGravity) {
                  alert('event.accelerationIncludingGravity is null');
                  return;
                }
                aX = event.accelerationIncludingGravity.x.toFixed(2);
                aY = event.accelerationIncludingGravity.y.toFixed(2);
                aZ = event.accelerationIncludingGravity.z.toFixed(2);
                A = Math.sqrt(aX * aX + aY * aY + aZ * aZ).toFixed(2);
              })
            }
          })
          .catch(console.error);
      } else {
        alert('DeviceMotionEvent.requestPermission is not found');
      }
      phase = 0;
    }

    var timer = window.setInterval(() => {
      displayData();      // displayData é–¢æ•°ã‚’å®Ÿè¡Œ
      displayInstruction();
    }, 100); // 33msã”ã¨ã«ï¼ˆ1ç§’é–“ã«ç´„30å›ï¼‰

    var accTimer = window.setInterval(() => {
      displayAcc();
    }, 33);

    function displayAcc() {
      var accMeter = document.getElementById("acc");
      accMeter.value = A;
      var accText = document.getElementById("accText");
      //accText.innerHTML = A;
    }


    function displayData() {


      var txt = document.getElementById("txt");


      /* txt.innerHTML = "x: " + aX + "<br>"         
        + "y: " + aY + "<br>"         
        + "z: " + aZ + "<br>"
        + "A: " + A; //*/



      //ç›´å‰ã®å€¤ã‚’ä¿å­˜
      index++;
      As[index % 100] = A;
      index %= 100;

      //ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸåˆ¤å®š
      var dif = A - As[(index - 1) % 100];
      if (index > 30 && dif < -3 && phase == 0 && Math.abs(As[(index - 1) % 100]) > 1) {
        alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n  ã‚‚ã—åº§ã£ã¦ã„ãŸã‚‰ã€ç«‹ã¡ä¸ŠãŒã‚‹ã€‚");
        phase = 1;
        index = 0;
        As = [];
      }

      if (index > 30 && dif < -2 && phase == 1) {
        alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n  ã‚‚ã—å£ã«å½“ãŸã‚Šãã†ã«ãªã£ãŸã‚‰ã€ç«‹ã¡æ­¢ã¾ã‚‹ã€‚");
        phase = 2;
        index = 0;
        As = [];
      }

      if (index > 30 && dif > 3 && phase == 2) {
        alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\næ¤…å­ã‚’æ¢ã™ã€‚\næ¤…å­ã«å‘ã‹ã£ã¦æ­©ãã€‚\nå‘ãã‚’å¤‰ãˆã‚‹ã€‚\næ¤…å­ã«åº§ã‚‹ã€‚\næ—¥ã€…ã®è¡Œå‹•ã«æ¡ä»¶åˆ†å²ãŒãªã„ã‹è€ƒãˆã‚‹ã€‚");
        phase = 3;
        index = 0;
        As = [];
      }

      var phaseBar=document.getElementById("progress");
      phaseBar.value=phase+1;
    }

    function displayInstruction() {
      var inst = document.getElementById("instruction");
      switch (phase) {
        case -1:
          inst.innerHTML = "å‘½ä»¤ï¼šåŠ é€Ÿåº¦ã‚»ãƒ³ã‚µã®è¨±å¯ğŸ˜Šã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ";
          break;
        case 0:
          inst.innerHTML = "å‘½ä»¤ï¼šç«‹ã¡ä¸ŠãŒã£ã¦ãã ã•ã„ã€‚";
          txt.innerHTML = '<img src="./img/standup.png" width = 30% />'
          break;
        case 1:
          inst.innerHTML = "å‘½ä»¤ï¼šå£ã«å‘ã‹ã£ã¦æ­©ã„ã¦ãã ã•ã„ã€‚"
          txt.innerHTML = '<img src="./img/walk.png" width = 30% />'
          break;
        case 2:
          inst.innerHTML = "å‘½ä»¤ï¼šæ¤…å­ã«åº§ã£ã¦ãã ã•ã„ã€‚"
          txt.innerHTML = '<img src="./img/sitdown.png" width = 30% />'
          break;
        case 3:
          inst.innerHTML = "ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
          txt.innerHTML = 'æ—¥å¸¸ã®è¡Œå‹•ã®ä¸­ã§ç„¡æ„è­˜ã«åˆ¤æ–­ã—ã¦ã„ã‚‹æ¡ä»¶ã«æ°—ã¥ã„ã¦ã‚‚ã‚‰ãˆãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ'
          break;
      }

    }
  </script>
</body>

</html>